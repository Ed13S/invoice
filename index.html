<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Invoice Creator</title>
    <style>
        :root { --primary: #1a73e8; --dark: #202124; --bg: #f8f9fa; }
        body { font-family: -apple-system, sans-serif; margin: 10px; color: #3c4043; background-color: #fff; }
        
        .no-print { background: var(--bg); padding: 20px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #dadce0; }
        textarea { width: 100%; height: 80px; border: 1px solid #dadce0; border-radius: 8px; padding: 12px; font-size: 16px; margin-bottom: 15px; box-sizing: border-box; }
        
        #manualForm { display: none; background: #fff; padding: 15px; border-radius: 8px; border: 1px solid #dadce0; margin-bottom: 15px; }
        .m-row { display: flex; gap: 10px; margin-bottom: 10px; }
        .m-input { flex: 2; padding: 10px; border: 1px solid #ccc; border-radius: 4px; }
        .m-price { flex: 1; padding: 10px; border: 1px solid #ccc; border-radius: 4px; }

        .btn-group { display: flex; gap: 10px; flex-wrap: wrap; }
        button { flex: 1; min-width: 120px; padding: 14px; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; }
        .gen-btn { background: var(--primary); color: white; }
        .add-btn { background: #1e8e3e; color: white; margin-top: 5px; width: 100%; }
        .manual-btn { background: #5f6368; color: white; }
        .clear-btn { background: #fff; color: #d93025; border: 1px solid #d93025; }
        .pdf-btn { background: #000; color: white; display: none; width: 100%; margin-top: 15px; font-size: 18px; }
        
        #status { font-size: 13px; margin-top: 10px; font-weight: bold; }

        #output { display: none; padding: 40px; border: 1px solid #dadce0; max-width: 800px; margin: auto; background: white; }
        .inv-header { display: flex; justify-content: space-between; margin-bottom: 30px; border-bottom: 2px solid #eee; padding-bottom: 15px; }
        .inv-title { color: var(--dark); font-size: 32px; font-weight: 800; text-transform: uppercase; margin: 0; }
        .biz-details { font-size: 13px; text-align: right; line-height: 1.6; }
        .billing-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 40px; margin-bottom: 30px; padding: 20px; background: var(--bg); border-radius: 8px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th { background: #f1f3f4; text-align: left; padding: 12px; font-size: 12px; border-bottom: 2px solid #ddd; }
        td { padding: 15px 12px; border-bottom: 1px solid #eee; font-size: 15px; }
        .total-box { width: 250px; border-top: 3px solid var(--dark); padding-top: 10px; margin-left: auto; margin-top: 20px; text-align: right; }
        
        @media print { 
            .no-print { display: none !important; } 
            #output { display: block !important; border: none !important; width: 100% !important; padding: 0 !important; } 
        }
    </style>
</head>
<body>

<div class="no-print">
    <h2 style="margin-top:0;">Taxi Invoice Automator</h2>
    <textarea id="inputData" placeholder="Paste trip logs here for AI..."></textarea>
    
    <div id="manualForm">
        <div class="m-row">
            <input type="text" id="m-desc" class="m-input" placeholder="Description (e.g. Trips from 01/01 to 05/01)">
            <input type="number" id="m-price" class="m-price" placeholder="Amount">
        </div>
        <button class="add-btn" onclick="addItem()">+ Add Manual Item</button>
    </div>

    <div class="btn-group">
        <button class="gen-btn" onclick="generateAI()">Use AI</button>
        <button class="manual-btn" onclick="showManual()">Manual Entry</button>
        <button class="clear-btn" onclick="clearAll()">Clear All</button>
        <button id="pdfBtn" class="pdf-btn" onclick="handlePrint()">PRINT INVOICE / SAVE PDF</button>
    </div>
    <div id="status"></div>
</div>

<div id="output">
    <div class="inv-header">
        <div>
            <div class="inv-title">Invoice</div>
            <div style="margin-top: 10px;"><strong>Invoice #:</strong> <span id="refNum"></span></div>
        </div>
        <div class="biz-details">
            <strong style="font-size: 18px;">Taxi Trips</strong><br>
            ABN: 15 685 270 239<br>
            Phone: 0404 843 222
        </div>
    </div>

    <div class="billing-grid">
        <div><strong>Bill To:</strong><br>Keqin Dai</div>
        <div style="text-align: right;"><strong>Date:</strong> <span id="todayDate"></span><br><strong>Due:</strong> <span id="dueDate"></span></div>
    </div>

    <table>
        <thead><tr><th>Description</th><th style="text-align: right;">Total</th></tr></thead>
        <tbody id="itemTable"></tbody>
    </table>

    <div class="total-box">
        <strong>TOTAL DUE</strong>
        <div id="grandTotal" style="font-size: 26px; font-weight: 700; color: #1e8e3e;"></div>
    </div>
</div>

<script>
const MY_API_KEY = "AIzaSyA4_ly7ZqKGhCiAD71WTUQArHqA7dqNt_A";
let invoiceItems = [];

function clearAll() {
    invoiceItems = [];
    document.getElementById('inputData').value = "";
    document.getElementById('output').style.display = "none";
    document.getElementById('pdfBtn').style.display = "none";
    document.getElementById('manualForm').style.display = "none";
    document.getElementById('status').innerText = "";
}

function showManual() {
    document.getElementById('manualForm').style.display = "block";
    document.getElementById('status').innerText = "Manual mode active.";
}

function addItem() {
    const d = document.getElementById('m-desc').value;
    const p = document.getElementById('m-price').value;
    if(d && p) {
        invoiceItems.push({ desc: d, price: parseFloat(p) });
        renderTable();
        document.getElementById('m-desc').value = "";
        document.getElementById('m-price').value = "";
    }
}

function handlePrint() {
    window.focus();
    setTimeout(() => {
        window.print();
    }, 250);
}

async function generateAI() {
    const text = document.getElementById('inputData').value;
    const status = document.getElementById('status');
    if (!text) return;
    status.style.color = "blue";
    status.innerText = "AI is calculating...";

    try {
        const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${MY_API_KEY}`;
        const response = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                contents: [{ parts: [{ text: `Input: "${text}". Rule: Calculate total price. Format description as "Trips from DD/MM to DD/MM". Output ONLY valid JSON: {"desc": "...", "price": 0.00}` }] }]
            })
        });
        const data = await response.json();
        const raw = data.candidates[0].content.parts[0].text;
        const cleaned = JSON.parse(raw.match(/\{.*\}/s)[0]);
        
        invoiceItems.push({ desc: cleaned.desc, price: cleaned.price });
        renderTable();
        status.style.color = "green";
        status.innerText = "✅ AI added " + cleaned.desc;
    } catch (e) {
        status.style.color = "red";
        status.innerText = "⚠️ AI Error. Try pasting simpler text or use Manual Entry.";
        console.error(e);
    }
}

function renderTable() {
    const now = new Date();
    const ref = String(now.getDate()).padStart(2, '0') + String(now.getMonth() + 1).padStart(2, '0') + now.getFullYear();
    const due = new Date(); due.setDate(now.getDate() + 7);

    document.getElementById('refNum').innerText = ref;
    document.getElementById('todayDate').innerText = now.toLocaleDateString('en-GB');
    document.getElementById('dueDate').innerText = due.toLocaleDateString('en-GB');

    let total = 0;
    let html = '';
    invoiceItems.forEach(item => {
        total += item.price;
        html += `<tr><td>${item.desc}</td><td style="text-align:right">$${item.price.toFixed(2)}</td></tr>`;
    });

    document.getElementById('itemTable').innerHTML = html;
    document.getElementById('grandTotal').innerText = '$' + total.toFixed(2);
    document.getElementById('output').style.display = 'block';
    document.getElementById('pdfBtn').style.display = 'block';
    document.getElementById('output').scrollIntoView({ behavior: 'smooth' });
}
</script>
</body>
</html>