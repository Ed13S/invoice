<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Taxi Invoice Automator (AI Enabled)</title>
    <style>
        body { font-family: -apple-system, sans-serif; padding: 15px; color: #333; background: #f0f2f5; line-height: 1.5; }
        .container { max-width: 600px; margin: auto; }
        .no-print { background: #fff; padding: 20px; border-radius: 12px; border: 1px solid #ddd; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        textarea { width: 100%; height: 120px; margin-bottom: 15px; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
        
        .btn-row { display: flex; gap: 8px; margin-bottom: 10px; flex-wrap: wrap; }
        button { flex: 1; min-width: 90px; padding: 14px; font-weight: bold; cursor: pointer; border-radius: 8px; border: none; transition: 0.2s; }
        .ai-btn { background: #2563eb; color: white; } 
        .manual-btn { background: #64748b; color: white; }
        .undo-btn { background: #f59e0b; color: white; }
        .reset-btn { background: #fee2e2; color: #dc2626; border: 1px solid #fecaca; }
        .print-btn { background: #000; color: white; width: 100%; margin-top: 20px; font-size: 18px; display: none; padding: 16px; border-radius: 10px; }
        
        #manualForm { display: none; background: #f8fafc; padding: 15px; border: 1px solid #e2e8f0; border-radius: 8px; margin-top: 10px; }
        .m-input { width: 100%; padding: 12px; margin: 5px 0 10px 0; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }

        #invoice { display: none; padding: 40px; border: 1px solid #ddd; background: white; border-radius: 4px; }
        .header { display: flex; justify-content: space-between; border-bottom: 2px solid #000; padding-bottom: 15px; }
        table { width: 100%; border-collapse: collapse; margin: 30px 0; }
        th { text-align: left; background: #f8f9fa; padding: 12px; border-bottom: 2px solid #ddd; }
        td { padding: 12px; border-bottom: 1px solid #eee; }
        .total-row { text-align: right; font-size: 24px; font-weight: bold; color: #059669; border-top: 2px solid #000; padding-top: 10px; }

        @media print {
            body { background: white; padding: 0; }
            .no-print, #manualForm, .btn-row { display: none !important; }
            #invoice { display: block !important; border: none !important; width: 100% !important; box-shadow: none; }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="no-print">
        <h3 style="margin-top:0; color: #2563eb;">AI Taxi Invoice Maker</h3>
        <textarea id="rawText" placeholder="Paste messy trip data, DiDi logs, or messages here..."></textarea>
        
        <div class="btn-row">
            <button class="ai-btn" onclick="callGemini()">Analyze & Add</button>
            <button class="manual-btn" onclick="toggleManual()">Manual</button>
            <button class="undo-btn" onclick="undoLast()">Undo</button>
            <button class="reset-btn" onclick="clearInvoice()">Clear All</button>
        </div>

        <div id="manualForm">
            <input type="text" id="mDesc" class="m-input" placeholder="Trips from 01/01 to 05/01">
            <input type="number" step="0.01" id="mPrice" class="m-input" placeholder="0.00">
            <button class="ai-btn" style="width:100%; background: #059669;" onclick="addManualItem()">+ Add to Invoice</button>
        </div>
        
        <div id="status" style="margin-top:10px; font-weight:bold; font-size: 14px;"></div>
    </div>

    <div id="invoice">
        <div class="header">
            <div><h1 style="margin:0; font-size: 32px;">INVOICE</h1><p>Inv #: <span id="invId"></span></p></div>
            <div style="text-align:right">
                <strong>Taxi Trips</strong><br>
                ABN: 15 685 270 239<br>
                Phone: 0404 843 222
            </div>
        </div>
        <div style="margin: 25px 0;"><strong>Bill To:</strong> Keqin Dai<br>Date: <span id="invDate"></span></div>
        <table>
            <thead><tr><th>Description</th><th style="text-align:right">Amount</th></tr></thead>
            <tbody id="rows"></tbody>
        </table>
        <div class="total-row">Total: <span id="grandTotal"></span></div>
        <button id="pBtn" class="print-btn" onclick="window.print()">PRINT / SAVE PDF</button>
    </div>
</div>

<script>
const GEMINI_KEY = "AIzaSyA4_ly7ZqKGhCiAD71WTUQArHqA7dqNt_A";
let items = [];

function clearInvoice() {
    items = [];
    document.getElementById('rawText').value = "";
    document.getElementById('status').innerText = "";
    render();
}

function undoLast() {
    items.pop();
    render();
    document.getElementById('status').innerText = "Last entry removed.";
}

function toggleManual() {
    const f = document.getElementById('manualForm');
    f.style.display = f.style.display === 'block' ? 'none' : 'block';
}

function addManualItem() {
    const d = document.getElementById('mDesc').value;
    const p = document.getElementById('mPrice').value;
    if(d && p) {
        items.push({ d: d, p: parseFloat(p) });
        render();
        document.getElementById('mDesc').value = "";
        document.getElementById('mPrice').value = "";
        document.getElementById('manualForm').style.display = 'none';
    }
}

async function callGemini() {
    const textInput = document.getElementById('rawText').value;
    const status = document.getElementById('status');
    if(!textInput) return;

    status.innerText = "⏳ AI is processing...";
    status.style.color = "#2563eb";

    try {
        const url = `https://generativelanguage.googleapis.com/v1/models/gemini-1.5-flash:generateContent?key=${GEMINI_KEY}`;
        const response = await fetch(url, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                contents: [{ parts: [{ text: `Identify trip dates and total cost in: "${textInput}". Return ONLY a JSON object: {"d": "Trips from DD/MM to DD/MM", "p": 0.00}` }] }]
            })
        });

        const data = await response.json();
        const aiText = data.candidates[0].content.parts[0].text;
        const match = aiText.match(/\{.*\}/s);
        
        const cleanJson = JSON.parse(match[0]);
        items.push(cleanJson);
        render();
        status.innerText = "✅ AI Added: " + cleanJson.d;
        status.style.color = "green";
        document.getElementById('rawText').value = "";
    } catch (e) {
        status.innerText = "❌ AI could not read that. Try Manual Entry.";
        status.style.color = "red";
    }
}

function render() {
    const now = new Date();
    document.getElementById('invId').innerText = now.getTime().toString().slice(-6);
    document.getElementById('invDate').innerText = now.toLocaleDateString('en-GB');
    let total = 0;
    let html = "";
    items.forEach(i => {
        total += i.p;
        html += `<tr><td>${i.d}</td><td style="text-align:right">$${i.p.toFixed(2)}</td></tr>`;
    });
    document.getElementById('rows').innerHTML = html;
    document.getElementById('grandTotal').innerText = "$" + total.toFixed(2);
    document.getElementById('invoice').style.display = items.length > 0 ? "block" : "none";
    document.getElementById('pBtn').style.display = items.length > 0 ? "block" : "none";
}
</script>
</body>
</html>